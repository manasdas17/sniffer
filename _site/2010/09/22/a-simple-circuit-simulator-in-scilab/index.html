<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="None worth writing.">
    <title>A Simple Circuit Simulator in Scilab</title>
    <meta name="author" content="Dilawar Singh" />
    <link rel="stylesheet" href="https://github.com/themes/minimal/stylesheets/styles.css">
 <style>
      header { zoom: 1.0; width: 150px}
      header h1 { margin-bottom: 5px; }
      header h1 a { color: #494949; font-weight: bold; }
      header h3 { margin-top: 20px; margin-bottom: 5px; }
      header p.view { margin-bottom: 5px; }
      header p.view small { padding-top: 2px; }
      header ul {
        zoom: 0.7;
        margin-top: 25px;
      }
      section { width: 600px }
      section p { margin-top: 10px; }
      section h1 { margin-bottom: 15px; }
      section h2 { margin-bottom: 10px; }
      section h2 { margin-bottom: 10px; }
      footer { bottom: 20px; }
      footer p { margin-bottom: 5px; }
      .half-width {
        float: left;
        width: 100px;
        list-style: none;
        padding: 5px;
        margin: 7px;
        margin-bottom: 10px;
      }
      .half-width h4 {
        margin-bottom: 5px;
      }
      .half-width ul {
        padding-left: 0;
      }
      .half-width ul li {
        list-style: inside;
        font-size: 15px;
      }
      .clear-fix {
        clear: both;
      }
    </style>
    <script src="https://github.com/themes/minimal/javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
</head>

<body>
    <div class="wrapper">
        <header>
        <h1><a href="/">Notes</a></h1>
        <p class="view"> <img src= "http://dilawar.github.io/images/pic_enhanced.jpg"
            alt="dilawar" height="150" width="150" /> </p>
        <p class="view"><a href="/projects/index.html">Open Source Projects <small>Might be useful to you</small></a></p>
        <p class="view"><a target="_blank"
            href="http://www.cen.iitb.ac.in/">Masters<small>Microelectronics and
                VLSI</small></a> 
        </p>
        <p class="view"><a target="_blank"
            href="http://www.ee.iitb.ac.in/~hpc">Ph. D.</a><small>Abandoned
            after 3 years</small>
        </p>
        <p class="view"><a target="_blank"
            href="http://www.ncbs.res.in/bhalla">Research Fellow <small>Moose,
                The Neural Simulator</small> </a> 
        </p>
        <p class="view"><a target="_blank"
            href="http://dilawarrajput.wordpress.com">Blog <small>This much I
                know</small></a> 
        </p>

        
        </header>

        <footer>
        </footer>

    <section id="post">
    <h1>A Simple Circuit Simulator in Scilab </h1>
<div class="content">
  <h1>1. Modified Nodal Analysis</h1>

<p>We implemented <a href="http://www.swarthmore.edu/NatSci/echeeve1/Ref/mna/MNA2.html">modified nodal analysis
(MNA)</a> in Scilab
even though I do not like this method. It is very bad for circuits having more
than few thousand nodes. It is implemented mostly for my understanding purpose.</p>

<p>Anyway, please make sure your circuit description file defined in Sec 2.1 does
not have current sources in parallel with any of the voltage sources. This is a
bug in this implementation and we probably will not remove it in near future
unless I get excited about it or you pay me for it [wink, wink].You read about
MNA on wikipedia or somewhere else. If the version of this implementation is
higher than 0.9, then it is assured that this bug has been removed.</p>

<h1>2. Scilab Implementation</h1>

<h2>2.1 Circuit Description file</h2>

<ul>
<li><p>It is more or less like Spice input file.</p></li>
<li><p>We do not allow small letters to define any of source e.g. use <strong>I</strong> instead
of <strong>i</strong> to write down a current source.Use <strong>R</strong> to write down a resistance
instead or <strong>r</strong>. I do not like using small letters except writing blah but
you can modify code to allow them.</p></li>
<li><p>Use any name after letter <strong>I</strong>, <strong>V</strong> and <strong>R</strong>. You can have same names
for different devices. We do not care in thisimplementation. It is
recommended that you use <strong>IXX, VXX,</strong> and <strong>RXX</strong> format.</p></li>
<li><p>We only handle <strong>V, I</strong> and <strong>R</strong> in this implementation but it can extended
to handle all kind of conductanceeasily. May be you'd like to do that
exercise.</p></li>
<li><p>Every line must end with semicolon.</p></li>
<li><p>Comments starts with #.</p></li>
<li><p>n0 is always ground node. Other nodes can have any names. It is recommended
that you start node name with letter 'n'.</p></li>
<li><p>We do not check the topology of the circuit. Give correct net-list.</p></li>
<li><p>We do not take any responsibility for any damage caused by using this implementation. Nonetheless, mybest wishes.</p></li>
</ul>


<p>For example, see the following file 2.1.</p>

<div class="highlight"><pre><code class="scilab"># <span class="n">Dilawar</span> <span class="o">-</span> <span class="n">dilawar</span><span class="p">@</span><span class="n">ee</span><span class="p">.</span><span class="n">iitb</span><span class="p">.</span><span class="n">ac</span><span class="p">.</span><span class="n">in</span>
# <span class="n">September</span> <span class="mi">18</span><span class="p">,</span> <span class="mf">2010.</span>
# <span class="n">This</span> <span class="n">is</span> <span class="n">net</span><span class="o">-</span><span class="nb">list</span> <span class="n">of</span> <span class="n">my</span> <span class="n">circuit</span><span class="p">.</span> <span class="n">It</span> <span class="n">should</span> <span class="n">be</span> <span class="nb">read</span> <span class="n">as</span> <span class="n">spice</span> <span class="n">net</span><span class="o">-</span><span class="nb">list</span> <span class="n">unless</span>
# <span class="k">otherwise</span> <span class="n">stated</span> <span class="n">explicitly</span> <span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.</span> <span class="n">IXX</span> <span class="n">means</span> <span class="n">current</span> <span class="n">source</span><span class="p">,</span> <span class="n">VXX</span> <span class="n">is</span> <span class="n">voltage</span>
# <span class="n">source</span><span class="p">,</span> <span class="n">RXX</span> <span class="n">is</span> <span class="n">resistance</span> <span class="nb">and</span> <span class="n">so</span> <span class="n">on</span><span class="p">.</span>
#
# <span class="n">Only</span> <span class="n">difference</span> <span class="n">here</span> <span class="n">is</span> <span class="n">that</span> <span class="n">we</span> <span class="k">do</span> <span class="n">not</span> <span class="n">allow</span> <span class="n">lower</span><span class="o">-</span><span class="k">case</span> <span class="n">letters</span> <span class="k">for</span> <span class="n">circuit</span>
# <span class="n">element</span> <span class="n">names</span><span class="p">.</span>
# <span class="n">n0</span> <span class="n">is</span> <span class="n">always</span> <span class="n">the</span> <span class="n">ground</span> <span class="n">node</span><span class="p">.</span>
<span class="n">IxB</span> <span class="n">n3</span> <span class="n">n0</span> <span class="mf">2.32</span><span class="p">;</span>
<span class="n">VyA</span> <span class="n">n1</span> <span class="n">n0</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">RyA</span> <span class="n">n1</span> <span class="n">n2</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="n">RzB</span> <span class="n">n2</span> <span class="n">n3</span> <span class="mf">0.1</span><span class="p">;</span>
<span class="n">RzC</span> <span class="n">n2</span> <span class="n">n0</span> <span class="mf">0.2</span><span class="p">;</span>
<span class="n">VyB</span> <span class="n">n3</span> <span class="n">n0</span> <span class="mi">3</span><span class="p">;</span>
</code></pre></div>


<h2>2.2 Parse this file</h2>

<p>Following is the SCILAB function which is used to parse this file. It is adequately commented.</p>

<div class="highlight"><pre><code class="scilab"><span class="c1">// Dilawar, dilawar@ee.iitb.ac.in</span>
<span class="c1">// Sep 18, 2010</span>
<span class="c1">// This Scilab function should parse file describing a circuit and should return</span>
<span class="c1">// list containing V, I and R.</span>
<span class="c1">// Only a circuit which has resistance, voltage</span>
<span class="c1">// sources and current sources as elements are dealt with</span>
<span class="c1">//. We do not take responsibility for</span>
<span class="c1">// any harm caused by using this script. Nonetheless my best wishes.</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">///</span>
<span class="c1">//</span>
<span class="c1">// About : Parse a file containing circuit elements and return a list containing</span>
<span class="c1">// structure. This structure holds information about the current, voltage, and</span>
<span class="c1">// resistance available in the circuit.</span>
<span class="c1">//</span>
<span class="c1">////////////////////////////////////////////////////////////////////////////////</span>
<span class="c1">///</span>
<span class="k">function</span><span class="w"> </span>[voltSource, curSource, valResistance, number] <span class="p">=</span><span class="w"></span>
<span class="nf">parseCircuitFile</span><span class="p">(</span>myCircuitFilePath<span class="p">)</span><span class="w"></span>

<span class="c1">//Error checking.</span>
<span class="p">[</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">]</span> <span class="p">=</span> <span class="nb">argn</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">if</span><span class="p">(</span> <span class="n">rhs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">then</span>
    <span class="nb">error</span><span class="p">(</span><span class="s">&quot;Expecting file path.&quot;</span><span class="p">);</span>
<span class="k">end</span>

<span class="c1">// Open file.</span>
<span class="p">[</span><span class="no">fd</span><span class="p">,</span> <span class="n">err</span><span class="p">]</span> <span class="p">=</span> <span class="nb">mopen</span><span class="p">(</span><span class="n">myCircuitFilePath</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>

<span class="c1">// Initialize numbers of entity in file.</span>
<span class="n">noOfcomments</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">noOfVoltageSources</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">noOfCurrentSources</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">noOfResistance</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// Create generic structure to store the data.This is not to be stored. Just an</span>
<span class="c1">// overview how it should be used.</span>
<span class="n">stComponent</span> <span class="p">=</span> <span class="nb">struct</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;V_I_R&#39;</span><span class="p">,</span> <span class="s">&#39;node1&#39;</span><span class="p">,</span> <span class="s">&#39;nX&#39;</span><span class="p">,</span> <span class="s">&#39;node0&#39;</span><span class="p">,</span> <span class="s">&#39;nY&#39;</span><span class="p">,</span> <span class="s">&#39;val&#39;</span><span class="p">,</span> <span class="mi">00</span><span class="p">)</span>

<span class="c1">// create lists to store data for each type of element.</span>
<span class="n">curSource</span><span class="p">=</span> <span class="nb">list</span><span class="p">();</span>
<span class="n">voltSource</span> <span class="p">=</span> <span class="nb">list</span><span class="p">();</span>
<span class="n">valResistance</span> <span class="p">=</span> <span class="nb">list</span><span class="p">();</span>

<span class="c1">// Now we parse the file to get the components.</span>
<span class="k">while</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">meof</span><span class="p">(</span><span class="no">fd</span><span class="p">)</span> <span class="nb">then</span> <span class="c1">// till end of file is not reached.</span>

    <span class="n">line</span> <span class="p">=</span> <span class="nb">mgetl</span><span class="p">(</span><span class="no">fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// get a line.</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">length</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="c1">// empty line, break. Else needed a mechanism to handle this bug.</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">else</span>
        <span class="n">ch</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// get first letter of line.</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&quot;#&quot;</span> <span class="nb">then</span>
            <span class="c1">//disp(&#39;Comment found.&#39;);</span>
            <span class="c1">// Do something.</span>
            <span class="n">noOfcomments</span> <span class="p">=</span> <span class="n">noOfcomments</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">elseif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&quot;I&quot;</span> <span class="nb">then</span>
            <span class="c1">//disp(&#39;We got a current source.&#39;);</span>

            <span class="n">noOfCurrentSources</span> <span class="p">=</span> <span class="n">noOfCurrentSources</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

            <span class="n">n</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>

            <span class="c1">//disp(n);</span>
            <span class="c1">// Get the name of the current source.</span>
            <span class="n">countSpace</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="no">j</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">for</span> <span class="no">i</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span>
                <span class="c1">//disp(&#39;Inside for.&#39;, i);</span>
                <span class="k">if</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">i</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot; &quot;</span> <span class="nb">then</span>
                    <span class="c1">//disp(&#39;Found space.&#39;);</span>

                    <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">countSpace</span> <span class="nb">then</span> <span class="c1">// first space delimit names.</span>
                        <span class="n">nameCurSource</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="c1">//disp(nameCurSource);</span>
                        <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span> <span class="c1">// remember the location of previous space.</span>

                  <span class="k">elseif</span>    <span class="mi">1</span> <span class="o">==</span> <span class="n">countSpace</span> <span class="nb">then</span> <span class="c1">// we got a node.</span>
                        <span class="n">upperNode</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span>
                        <span class="c1">//disp(upperNode);</span>

                    <span class="k">elseif</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">countSpace</span> <span class="nb">then</span> <span class="c1">// we got a node</span>
                        <span class="n">lowerNode</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span>
                        <span class="c1">//disp(lowerNode);</span>
                    <span class="k">end</span><span class="p">;</span> <span class="c1">// inside if-elseif end here.</span>
                <span class="k">end</span><span class="p">;</span> <span class="c1">// outside if ends here.</span>

           <span class="c1">// Now there is no space left at the end of line. So we can not read</span>
           <span class="c1">// value of the component using this algorithm. We use &#39;;&#39; to read</span>
           <span class="c1">// this value.</span>

                <span class="k">if</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">i</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;;&quot;</span> <span class="nb">then</span> <span class="c1">// we got a value, uhuu</span>
                    <span class="n">val</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                    <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span>
                    <span class="c1">//disp(&#39;Value is:&#39;, val);</span>
                <span class="k">end</span><span class="p">;</span>

            <span class="k">end</span><span class="p">;</span> <span class="c1">// for-loop ends here.</span>

            <span class="c1">// Put all the data into matrix.</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="nb">type</span> <span class="p">=</span> <span class="s">&quot;I&quot;</span><span class="p">;</span> <span class="c1">// this is a current source.</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">nameCurSource</span><span class="p">;</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">node1</span> <span class="p">=</span> <span class="n">upperNode</span><span class="p">;</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">node0</span> <span class="p">=</span> <span class="n">lowerNode</span><span class="p">;</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">val</span> <span class="p">=</span> <span class="n">val</span><span class="p">;</span>

        <span class="c1">// This list will contain information in this order. Index [1] stores</span>
        <span class="c1">// a matrix in which entries specify that stored is an struct. Index[2]</span>
        <span class="c1">// will provide with a matrix [1, 1] which I am not sure what it is.</span>
        <span class="c1">// Index[3] is the type of the component. I for current source, V for</span>
        <span class="c1">// voltage, R for resistance. Index[4] is name of the component.Index[5]</span>
        <span class="c1">// is the upper node of connection of this component in circuit and</span>
        <span class="c1">// Index[6] is the lower node. Index[7] is the corresponding value in</span>
        <span class="c1">// string which must be converted into double before use.</span>
            <span class="n">curSource</span> <span class="p">=</span> <span class="nb">lstcat</span><span class="p">(</span><span class="n">curSource</span><span class="p">,</span> <span class="n">stComponent</span><span class="p">);</span>

        <span class="k">elseif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&quot;R&quot;</span> <span class="nb">then</span>
            <span class="c1">//disp(&#39;We got a resistance.&#39;);</span>
            <span class="c1">// Do something.</span>
            <span class="n">noOfResistance</span> <span class="p">=</span> <span class="n">noOfResistance</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

            <span class="n">n</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>

            <span class="n">countSpace</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="no">j</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">for</span> <span class="no">i</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span>
                <span class="c1">//disp(&#39;Inside for.&#39;, i);</span>
                <span class="k">if</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">i</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot; &quot;</span> <span class="nb">then</span>
                    <span class="c1">//disp(&#39;Found space.&#39;);</span>

                    <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">countSpace</span> <span class="nb">then</span> <span class="c1">// first space delimit names.</span>
                        <span class="n">nameResistance</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="c1">//disp(nameResistance);</span>
                        <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span> <span class="c1">// remember the location of previous space.</span>

                  <span class="k">elseif</span>    <span class="mi">1</span> <span class="o">==</span> <span class="n">countSpace</span> <span class="nb">then</span> <span class="c1">// we got a node.</span>
                        <span class="n">upperNode</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span>
                        <span class="c1">//disp(upperNode);</span>

                    <span class="k">elseif</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">countSpace</span> <span class="nb">then</span> <span class="c1">// we got a node</span>
                        <span class="n">lowerNode</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span>
                        <span class="c1">//disp(lowerNode);</span>
                    <span class="k">end</span><span class="p">;</span> <span class="c1">// inside if-elseif end here.</span>
                <span class="k">end</span><span class="p">;</span> <span class="c1">// outside if ends here.</span>

            <span class="c1">// Now there is no space left at the end of line. So we can not read</span>
            <span class="c1">// value of the component using this algorithm. We use &#39;;&#39; to read</span>
            <span class="c1">// this value.</span>

                <span class="k">if</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">i</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;;&quot;</span> <span class="nb">then</span> <span class="c1">// we got a value, uhuu</span>
                    <span class="n">val</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                    <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span>
                    <span class="c1">//disp(&#39;Value is:&#39;, val);</span>
                <span class="k">end</span><span class="p">;</span>

            <span class="k">end</span><span class="p">;</span> <span class="c1">// for-loop ends here.</span>

            <span class="c1">// Put all the data into matrix.</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="nb">type</span> <span class="p">=</span> <span class="s">&quot;R&quot;</span><span class="p">;</span> <span class="c1">// this is a resistance.</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">nameResistance</span><span class="p">;</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">node1</span> <span class="p">=</span> <span class="n">upperNode</span><span class="p">;</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">node0</span> <span class="p">=</span> <span class="n">lowerNode</span><span class="p">;</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">val</span> <span class="p">=</span> <span class="n">val</span><span class="p">;</span>

       <span class="c1">// This list will contain information in this order. Index 1, stores</span>
       <span class="c1">// a matrix in which entries specify that stored is an struct. Index 2</span>
       <span class="c1">// will provide with a matrix [1, 1] which I am not sure what it is.</span>
       <span class="c1">// Index 3 is the type of the component. I for current source, V for</span>
       <span class="c1">// voltage, R for resistance. Index 4  is name of the component.Index 5</span>
       <span class="c1">// is the upper node of connection of this component in circuit and</span>
       <span class="c1">// Index 6 is the lower node. Index 7 is the corresponding value of the</span>
       <span class="c1">// component.</span>
     <span class="n">valResistance</span> <span class="p">=</span> <span class="nb">lstcat</span><span class="p">(</span><span class="n">valResistance</span><span class="p">,</span> <span class="n">stComponent</span><span class="p">);</span>

        <span class="k">elseif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&quot;V&quot;</span> <span class="nb">then</span>
            <span class="c1">//disp(&#39;We got a voltage source.&#39;);</span>
            <span class="c1">// Do something.</span>
            <span class="n">noOfVoltageSources</span> <span class="p">=</span> <span class="n">noOfVoltageSources</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

            <span class="n">n</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>

            <span class="c1">//disp(n);</span>
            <span class="c1">// Get the name of the current source.</span>
            <span class="n">countSpace</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="no">j</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">for</span> <span class="no">i</span> <span class="p">=</span> <span class="mi">1</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span>
                <span class="c1">//disp(&#39;Inside for.&#39;, i);</span>
                <span class="k">if</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">i</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot; &quot;</span> <span class="nb">then</span>
                    <span class="c1">//disp(&#39;Found space.&#39;);</span>

                    <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">countSpace</span> <span class="nb">then</span> <span class="c1">// first space delimit names.</span>
                        <span class="n">nameVoltSource</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="c1">//disp(nameVoltSource);</span>
                        <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span> <span class="c1">// remember the location of previous space.</span>

                  <span class="k">elseif</span>    <span class="mi">1</span> <span class="o">==</span> <span class="n">countSpace</span> <span class="nb">then</span> <span class="c1">// we got a node.</span>
                        <span class="n">upperNode</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span>
                        <span class="c1">//disp(upperNode);</span>

                    <span class="k">elseif</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">countSpace</span> <span class="nb">then</span> <span class="c1">// we got a node</span>
                        <span class="n">lowerNode</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                        <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span>
                        <span class="c1">//disp(lowerNode);</span>
                    <span class="k">end</span><span class="p">;</span> <span class="c1">// inside if-elseif end here.</span>
                <span class="k">end</span><span class="p">;</span> <span class="c1">// outside if ends here.</span>

            <span class="c1">// Now there is no space left at the end of line. So we can not read</span>
            <span class="c1">// value of the component using this algorithm. We use &#39;;&#39; to read</span>
            <span class="c1">// this value.</span>

                <span class="k">if</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">i</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;;&quot;</span> <span class="nb">then</span> <span class="c1">// we got a value, uhuu</span>
                    <span class="n">val</span> <span class="p">=</span> <span class="nb">part</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="no">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="no">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                    <span class="n">countSpace</span> <span class="p">=</span> <span class="n">countSpace</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="no">j</span> <span class="p">=</span> <span class="no">i</span><span class="p">;</span>
                    <span class="c1">//disp(&#39;Value is:&#39;, val);</span>
                <span class="k">end</span><span class="p">;</span>

            <span class="k">end</span><span class="p">;</span> <span class="c1">// for-loop ends here.</span>

            <span class="c1">// Put all the data into matrix.</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="nb">type</span> <span class="p">=</span> <span class="s">&quot;V&quot;</span><span class="p">;</span> <span class="c1">// this is a voltage source.</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">nameVoltSource</span><span class="p">;</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">node1</span> <span class="p">=</span> <span class="n">upperNode</span><span class="p">;</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">node0</span> <span class="p">=</span> <span class="n">lowerNode</span><span class="p">;</span>
            <span class="n">stComponent</span><span class="p">.</span><span class="n">val</span> <span class="p">=</span> <span class="n">val</span><span class="p">;</span>

          <span class="c1">// This list will contain information in this order. Index 1, stores</span>
          <span class="c1">// a matrix in which entries specify that stored is an struct. Index 2</span>
          <span class="c1">// will provide with a matrix [1, 1] which I am not sure what it is.</span>
          <span class="c1">// Index[3] is the type of the component. I for current source, V for</span>
          <span class="c1">// voltage, R for resistance. Index 4 is name of the component.Index 5</span>
         <span class="c1">// is the upper node of connection of this component in circuit and</span>
         <span class="c1">// Index 6 is the lower node. Index 7 is the corresponding value of the</span>
          <span class="c1">// component.</span>
            <span class="n">voltSource</span> <span class="p">=</span> <span class="nb">lstcat</span><span class="p">(</span><span class="n">voltSource</span><span class="p">,</span> <span class="n">stComponent</span><span class="p">);</span>

        <span class="k">else</span>
            <span class="nb">disp</span><span class="p">(</span><span class="s">&#39;Mayday. Alien found. Check your circuit file.&#39;</span><span class="p">);</span>
            <span class="c1">// Please do something</span>
        <span class="k">end</span><span class="p">;</span> <span class="c1">// if elseif else ends here.</span>
    <span class="k">end</span><span class="p">;</span> <span class="c1">//if else ends here.</span>
<span class="k">end</span><span class="p">;</span> <span class="c1">// while ends here.</span>
<span class="nb">mclose</span><span class="p">(</span><span class="no">fd</span><span class="p">);</span>
<span class="c1">// return number of elements in circuit.</span>
<span class="n">number</span> <span class="p">=</span> <span class="p">[</span><span class="n">noOfVoltageSources</span><span class="p">,</span> <span class="n">noOfCurrentSources</span><span class="p">,</span> <span class="n">noOfResistance</span><span class="p">];</span>

<span class="k">endfunction</span>
</code></pre></div>


<h2>2.3 Generate coefficient matrix</h2>

<p>Well this part should have a better documentation. matM is the matrix which will contain all the coefficients. Matrix matB got all  the coefficient matrix. It is better that you work out a simple example for MNA and understand the structure of these matrices.</p>

<div class="highlight"><pre><code class="matlab"><span class="o">//</span> <span class="n">Scilab</span> <span class="n">file</span><span class="p">.</span>
<span class="o">//</span> <span class="n">Funtion</span>
<span class="o">//</span> <span class="n">Dilawar</span> <span class="n">Singh</span><span class="p">,</span> <span class="n">Sepp</span> <span class="mi">19</span><span class="p">,</span> <span class="mf">2010.</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">script</span> <span class="n">will</span> <span class="n">compute</span> <span class="n">the</span> <span class="n">matrices</span> <span class="n">required</span> <span class="n">to</span> <span class="n">solve</span> <span class="n">the</span> <span class="n">electric</span> <span class="n">circuit</span>
<span class="o">//</span> <span class="n">as</span> <span class="n">described</span> <span class="n">in</span> <span class="n">a</span> <span class="n">text</span> <span class="n">file</span><span class="p">.</span> <span class="n">To</span> <span class="n">generate</span> <span class="n">the</span> <span class="n">matrix</span> <span class="n">we</span> <span class="n">will</span> <span class="n">use</span> <span class="n">data</span>
<span class="o">//</span> <span class="n">structure</span> <span class="n">returned</span> <span class="n">by</span> <span class="n">a</span> <span class="k">function</span> <span class="n">defined</span> <span class="n">in</span> <span class="n">parseCircuitFile</span><span class="p">.</span><span class="n">sce</span> <span class="n">file</span><span class="p">.</span>
<span class="o">//</span>

<span class="o">//</span> <span class="n">matM</span> <span class="p">:</span> <span class="n">coefficient</span> <span class="n">matrix</span><span class="p">.</span>
<span class="o">//</span> <span class="n">matB</span> <span class="p">:</span> <span class="n">source</span> <span class="n">matrix</span><span class="p">.</span>
<span class="o">//</span> <span class="n">listNodes</span> <span class="p">:</span> <span class="n">list</span> <span class="n">having</span> <span class="n">distince</span> <span class="n">nodes</span> <span class="n">at</span> <span class="n">which</span> <span class="n">equations</span> <span class="n">are</span> <span class="n">written</span><span class="p">.</span>
<span class="o">//</span> <span class="n">nodeV</span> <span class="p">:</span> <span class="n">nodes</span> <span class="n">where</span> <span class="n">voltage</span> <span class="n">sources</span> <span class="n">are</span> <span class="n">attached</span><span class="p">.</span>
<span class="o">//</span> <span class="n">etc</span><span class="p">.</span>
<span class="k">function</span><span class="w"> </span>[matM, matB, listNodes, nodeV] <span class="p">=</span><span class="w"> </span><span class="nf">generateMatrix</span><span class="p">(</span>myFileName<span class="p">)</span><span class="w"></span>
<span class="n">exec</span><span class="p">(</span><span class="s">&#39;./parseCircuitFile.sci&#39;</span><span class="p">);</span>
<span class="o">//</span> <span class="n">open</span> <span class="n">file</span> <span class="n">and</span> <span class="n">parse</span> <span class="n">the</span> <span class="n">file</span><span class="p">.</span>
<span class="p">[</span><span class="n">vS</span><span class="p">,</span> <span class="n">iS</span><span class="p">,</span> <span class="n">rS</span><span class="p">,</span> <span class="n">numS</span><span class="p">]</span> <span class="p">=</span> <span class="n">parseCircuitFile</span><span class="p">(</span><span class="n">myFileName</span><span class="p">);</span>
<span class="o">//</span> <span class="n">We</span> <span class="n">got</span> <span class="n">all</span> <span class="n">the</span> <span class="n">sources</span><span class="p">.</span>

<span class="o">//</span> <span class="n">Build</span> <span class="n">the</span> <span class="n">matrix</span><span class="p">.</span>
<span class="o">//</span> <span class="n">calculate</span> <span class="n">the</span> <span class="n">no</span> <span class="n">of</span> <span class="n">voltage</span> <span class="n">sources</span><span class="p">.</span>
<span class="n">nV</span> <span class="p">=</span> <span class="n">numS</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="o">//</span> <span class="n">no</span> <span class="n">of</span> <span class="n">current</span> <span class="n">source</span><span class="p">.</span>
<span class="n">nI</span> <span class="p">=</span> <span class="n">numS</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="o">//</span> <span class="n">no</span> <span class="n">of</span> <span class="n">resistors</span>
<span class="n">nR</span> <span class="p">=</span> <span class="n">numS</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="o">//////////////////////////////////////////////////</span>
<span class="o">//</span><span class="n">To</span> <span class="n">do</span> <span class="p">:</span> <span class="n">Extract</span> <span class="n">the</span> <span class="n">topology</span> <span class="n">of</span> <span class="n">the</span> <span class="n">network</span> <span class="n">here</span><span class="p">.</span>

<span class="o">//</span> <span class="n">First</span> <span class="n">get</span> <span class="n">the</span> <span class="n">node</span> <span class="n">lists</span><span class="p">.</span>
<span class="n">nodeV</span> <span class="p">=</span> <span class="p">[];</span>
<span class="n">nodeI</span> <span class="p">=</span> <span class="p">[];</span>
<span class="n">nodeR</span> <span class="p">=</span> <span class="p">[];</span>
<span class="o">//</span> <span class="n">node</span> <span class="n">with</span> <span class="n">voltage</span> <span class="n">source</span><span class="p">.</span>
<span class="k">for</span> <span class="nb">j</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">nV</span><span class="p">,</span>
    <span class="n">nodeV</span> <span class="p">=</span> <span class="p">[</span><span class="n">nodeV</span><span class="p">,</span> <span class="n">vS</span><span class="p">((</span><span class="nb">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">vS</span><span class="p">((</span><span class="nb">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)];</span>
<span class="k">end</span><span class="p">;</span>
<span class="o">//</span><span class="n">nodes</span> <span class="n">with</span> <span class="n">current</span> <span class="n">sources</span><span class="p">.</span>
<span class="k">for</span> <span class="nb">j</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">nI</span><span class="p">,</span>
    <span class="n">nodeI</span> <span class="p">=</span> <span class="p">[</span><span class="n">nodeI</span><span class="p">,</span> <span class="n">iS</span><span class="p">((</span><span class="nb">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">iS</span><span class="p">((</span><span class="nb">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)];</span>
<span class="k">end</span><span class="p">;</span>
<span class="o">//</span> <span class="n">nodes</span> <span class="n">with</span> <span class="n">resistance</span>
<span class="k">for</span> <span class="nb">j</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">nR</span><span class="p">,</span>
    <span class="n">nodeR</span> <span class="p">=</span> <span class="p">[</span><span class="n">nodeR</span><span class="p">,</span> <span class="n">rS</span><span class="p">((</span><span class="nb">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">rS</span><span class="p">((</span><span class="nb">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)];</span>
<span class="k">end</span><span class="p">;</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">can</span> <span class="n">now</span> <span class="n">have</span> <span class="n">some</span> <span class="n">sort</span> <span class="n">of</span> <span class="n">circuit</span> <span class="n">topology</span><span class="p">.</span>

<span class="o">//</span> <span class="n">Extract</span> <span class="n">nodes</span> <span class="n">on</span> <span class="n">which</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">write</span> <span class="n">the</span> <span class="n">nodal</span> <span class="n">equations</span><span class="p">.</span> <span class="n">This</span> <span class="n">is</span>
<span class="o">//</span> <span class="n">neccessary</span> <span class="n">since</span> <span class="n">a</span> <span class="n">node</span> <span class="n">mostly</span> <span class="n">have</span> <span class="n">repeated</span> <span class="n">entry</span> <span class="n">due</span> <span class="n">to</span> <span class="n">more</span> <span class="n">than</span> <span class="n">one</span>
<span class="o">//</span> <span class="n">element</span> <span class="n">incident</span> <span class="n">to</span> <span class="n">it</span><span class="p">.</span>
<span class="o">//</span> <span class="n">diffNodes</span> <span class="n">store</span> <span class="n">all</span> <span class="n">such</span> <span class="n">nodes</span><span class="p">.</span>
<span class="o">//</span> <span class="n">TODO</span> <span class="p">:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">not</span> <span class="n">an</span> <span class="n">efficient</span> <span class="n">implementation</span><span class="p">.</span>
<span class="n">tempNodes</span> <span class="p">=</span> <span class="p">[</span><span class="n">nodeV</span><span class="p">,</span> <span class="n">nodeI</span><span class="p">,</span> <span class="n">nodeR</span><span class="p">];</span>
<span class="n">diffNodes</span> <span class="p">=</span> <span class="p">[];</span> <span class="o">//</span> <span class="n">Different</span> <span class="n">node</span>
<span class="n">n</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">tempNodes</span><span class="p">));</span>
<span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">allMatch</span> <span class="p">=</span> <span class="p">[];</span>
<span class="k">while</span> <span class="nb">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="n">then</span>
    <span class="nb">j</span> <span class="p">=</span> <span class="nb">i</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span> <span class="nb">j</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="n">then</span>
        <span class="k">if</span> <span class="n">tempNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="o">~=</span> <span class="n">tempNodes</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span> <span class="n">then</span>
            <span class="o">//</span><span class="nb">disp</span><span class="p">(</span><span class="s">&#39;Dont Match&#39;</span><span class="p">);</span>
            <span class="nb">j</span> <span class="p">=</span> <span class="nb">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="o">//</span><span class="nb">disp</span><span class="p">(</span><span class="s">&#39;Match.&#39;</span><span class="p">);</span>
            <span class="n">allMatch</span> <span class="p">=</span> <span class="p">[</span><span class="n">allMatch</span><span class="p">,</span> <span class="nb">j</span><span class="p">];</span>
            <span class="n">tempNodes</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span> <span class="p">=</span> <span class="p">[];</span> <span class="o">//</span><span class="n">Delete</span> <span class="n">it</span><span class="p">.</span>
            <span class="nb">j</span> <span class="p">=</span> <span class="nb">j</span><span class="p">;</span>
            <span class="n">n</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">tempNodes</span><span class="p">));</span>
        <span class="k">end</span><span class="p">;</span>
    <span class="k">end</span><span class="p">;</span>
    <span class="k">if</span> <span class="nb">length</span><span class="p">(</span><span class="n">allMatch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="n">then</span>
        <span class="n">diffNodes</span> <span class="p">=</span> <span class="p">[</span><span class="n">diffNodes</span><span class="p">,</span> <span class="n">tempNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">)];</span>
        <span class="nb">i</span> <span class="p">=</span> <span class="nb">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">for</span> <span class="n">p</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">length</span><span class="p">(</span><span class="n">allMatch</span><span class="p">),</span>
            <span class="n">tempNodes</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span> <span class="p">=</span> <span class="p">[];</span>
        <span class="k">end</span><span class="p">;</span>
        <span class="n">diffNodes</span> <span class="p">=</span> <span class="p">[</span><span class="n">diffNodes</span><span class="p">,</span> <span class="n">tempNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">)];</span>
        <span class="nb">i</span> <span class="p">=</span> <span class="nb">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">end</span><span class="p">;</span>
   <span class="n">n</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">tempNodes</span><span class="p">));</span>
<span class="k">end</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Discard</span> <span class="n">n0</span> <span class="n">since</span> <span class="n">by</span> <span class="n">constrain</span> <span class="n">this</span> <span class="n">is</span> <span class="n">our</span> <span class="n">ground</span> <span class="n">node</span><span class="p">.</span>
<span class="o">//</span> <span class="n">Now</span> <span class="n">we</span> <span class="n">can</span> <span class="n">use</span> <span class="n">any</span> <span class="n">method</span> <span class="n">to</span> <span class="n">solve</span> <span class="n">it</span><span class="p">.</span> <span class="n">Either</span> <span class="n">MNA</span> <span class="n">or</span> <span class="n">NAL</span><span class="o">-</span><span class="n">NBK</span> <span class="k">methods</span><span class="p">.</span>
<span class="o">//</span> <span class="n">Here</span> <span class="n">we</span> <span class="n">use</span> <span class="n">MNA</span> <span class="n">since</span> <span class="n">it</span> <span class="n">will</span> <span class="n">take</span> <span class="n">less</span> <span class="n">time</span> <span class="n">to</span> <span class="n">implement</span> <span class="n">now</span><span class="p">.</span>

<span class="o">//</span> <span class="n">Now</span> <span class="n">we</span> <span class="n">will</span> <span class="n">have</span> <span class="n">numNodes</span> <span class="o">+</span> <span class="n">nV</span> <span class="n">variables</span><span class="p">.</span>
<span class="o">//</span> <span class="n">Add</span> <span class="n">all</span> <span class="n">the</span> <span class="n">resistance</span> <span class="n">incident</span> <span class="n">on</span> <span class="n">one</span> <span class="n">node</span><span class="p">.</span> <span class="n">They</span> <span class="n">will</span> <span class="n">form</span> <span class="n">the</span> <span class="n">diagonal</span>
<span class="o">//</span> <span class="n">entries</span> <span class="k">for</span> <span class="n">matrix</span> <span class="k">for</span> <span class="n">node</span> <span class="n">equations</span><span class="p">.</span> <span class="n">Non</span><span class="o">-</span><span class="n">diagonal</span> <span class="n">entries</span> <span class="n">can</span> <span class="n">also</span> <span class="n">be</span>
<span class="o">//</span> <span class="n">generated</span> <span class="n">inside</span> <span class="n">this</span> <span class="n">part</span> <span class="n">only</span><span class="p">.</span> <span class="n">But</span> <span class="n">we</span> <span class="n">give</span> <span class="n">another</span> <span class="n">block</span> <span class="n">of</span> <span class="n">code</span> <span class="n">to</span> <span class="n">make</span> <span class="n">it</span>
<span class="o">//</span> <span class="n">look</span> <span class="n">more</span> <span class="n">straigtforward</span><span class="p">.</span> <span class="n">Both</span> <span class="n">of</span> <span class="n">these</span> <span class="n">loops</span> <span class="n">should</span> <span class="n">be</span> <span class="n">merged</span> <span class="n">into</span> <span class="n">one</span> <span class="k">for</span>
<span class="o">//</span> <span class="n">less</span> <span class="n">time</span> <span class="n">consumption</span><span class="p">.</span>
<span class="n">matM</span> <span class="p">=</span> <span class="p">[];</span>
<span class="n">diagM</span> <span class="p">=</span> <span class="p">[];</span>
 <span class="o">//</span> <span class="n">Remove</span> <span class="n">n0</span> <span class="n">from</span> <span class="n">the</span> <span class="n">diff</span> <span class="n">nodes</span> <span class="n">and</span> <span class="n">use</span> <span class="n">it</span> <span class="n">to</span> <span class="n">build</span> <span class="n">the</span> <span class="n">conducatance</span> <span class="n">matrices</span><span class="p">.</span>
 <span class="o">//</span> <span class="n">This</span> <span class="n">way</span> <span class="n">it</span> <span class="n">is</span> <span class="n">more</span> <span class="n">natural</span><span class="p">.</span> <span class="n">We</span> <span class="n">could</span> <span class="n">have</span> <span class="n">ignored</span> <span class="n">this</span> <span class="n">node</span> <span class="n">previously</span> <span class="n">but</span>
 <span class="o">//</span> <span class="n">we</span> <span class="n">keep</span> <span class="n">it</span><span class="p">,</span> <span class="n">just</span> <span class="n">in</span> <span class="k">case</span> <span class="k">if</span> <span class="n">we</span> <span class="n">need</span> <span class="n">it</span> <span class="n">in</span> <span class="n">future</span><span class="p">.</span>
 <span class="n">listNodes</span> <span class="p">=</span> <span class="p">[];</span>
 <span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">length</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">diffNodes</span><span class="p">)),</span>
     <span class="k">if</span> <span class="n">diffNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="o">~=</span> <span class="s">&#39;n0&#39;</span> <span class="n">then</span>
         <span class="n">listNodes</span> <span class="p">=</span> <span class="p">[</span><span class="n">listNodes</span><span class="p">,</span> <span class="n">diffNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">)];</span>
     <span class="k">end</span><span class="p">;</span>
 <span class="k">end</span><span class="p">;</span>

<span class="n">numNodes</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">listNodes</span><span class="p">));</span> <span class="o">//</span> <span class="n">total</span> <span class="n">nodes</span> <span class="n">excluding</span> <span class="n">ground</span> <span class="s">&#39;n0&#39;</span><span class="p">.</span>
<span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">numNodes</span><span class="p">,</span>
    <span class="n">diagR</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">p</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="p">(</span><span class="n">lstsize</span><span class="p">(</span><span class="n">rS</span><span class="p">)</span><span class="o">/</span><span class="mi">7</span><span class="p">),</span>
        <span class="k">if</span> <span class="n">listNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">rS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="n">then</span>
            <span class="n">diagR</span> <span class="p">=</span> <span class="n">diagR</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">evstr</span><span class="p">(</span><span class="n">rS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span> <span class="o">//</span> <span class="n">get</span> <span class="n">the</span> <span class="n">conductance</span><span class="p">.</span>
        <span class="k">elseif</span> <span class="n">listNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">rS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="n">then</span>
            <span class="n">diagR</span> <span class="p">=</span> <span class="n">diagR</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">evstr</span><span class="p">(</span><span class="n">rS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span>
        <span class="k">end</span><span class="p">;</span>
    <span class="k">end</span><span class="p">;</span>
    <span class="n">matM</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span> <span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="n">diagR</span><span class="p">;</span>
<span class="k">end</span><span class="p">;</span>
<span class="o">//</span> <span class="n">Here</span> <span class="n">we</span> <span class="n">extract</span> <span class="n">non</span><span class="o">-</span><span class="n">diagonal</span> <span class="n">entries</span><span class="p">.</span> <span class="n">Since</span> <span class="n">matM</span> <span class="n">should</span> <span class="n">be</span> <span class="n">symetrical</span> <span class="n">about</span>
<span class="o">//</span> <span class="n">its</span> <span class="n">diagonal</span><span class="p">.</span> <span class="n">Life</span> <span class="n">is</span> <span class="n">slightly</span> <span class="n">easy</span><span class="p">.</span>
<span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">numNodes</span><span class="p">,</span>
    <span class="n">nonDiagR</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span>  <span class="nb">j</span> <span class="p">=</span> <span class="nb">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">:</span> <span class="n">numNodes</span><span class="p">,</span>
        <span class="k">for</span> <span class="n">p</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">lstsize</span><span class="p">(</span><span class="n">rS</span><span class="p">)</span><span class="o">/</span><span class="mi">7</span><span class="p">,</span>
            <span class="k">if</span> <span class="n">listNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">rS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="n">then</span>
                <span class="k">if</span> <span class="n">listNodes</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span> <span class="o">==</span> <span class="n">rS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="n">then</span>
                    <span class="n">nonDiagR</span> <span class="p">=</span> <span class="n">nonDiagR</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">evstr</span><span class="p">(</span><span class="n">rS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span> <span class="o">//</span>
<span class="n">conductance</span><span class="p">.</span>
                <span class="k">end</span><span class="p">;</span>
<span class="o">//</span> <span class="n">it</span> <span class="n">might</span> <span class="n">happen</span> <span class="n">that</span> <span class="n">we</span> <span class="n">have</span> <span class="n">reversed</span> <span class="n">the</span> <span class="n">order</span> <span class="n">of</span> <span class="n">nodes</span> <span class="k">while</span> <span class="n">writing</span> <span class="n">R</span><span class="p">.</span>
<span class="o">//</span> <span class="n">Though</span><span class="p">,</span> <span class="n">the</span> <span class="n">way</span> <span class="n">we</span> <span class="n">are</span> <span class="n">extracting</span> <span class="n">the</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">it</span> <span class="n">should</span> <span class="n">never</span> <span class="n">happen</span><span class="p">.</span> <span class="n">But</span>
<span class="o">//</span> <span class="n">anyway</span> <span class="k">if</span> <span class="n">someone</span> <span class="n">modifies</span> <span class="n">a</span> <span class="n">part</span><span class="p">,</span> <span class="n">we</span> <span class="n">should</span> <span class="n">not</span> <span class="n">have</span> <span class="n">any</span> <span class="n">bug</span> <span class="n">here</span><span class="p">.</span>
            <span class="k">elseif</span> <span class="n">listNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">rS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="n">then</span>
                 <span class="k">if</span> <span class="n">listNodes</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span> <span class="o">==</span> <span class="n">rS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="n">then</span>
                    <span class="o">//</span> <span class="n">Following</span> <span class="n">is</span> <span class="n">conductance</span><span class="p">.</span>
                    <span class="n">nonDiagR</span> <span class="p">=</span> <span class="n">nonDiagR</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">evstr</span><span class="p">(</span><span class="n">rS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span><span class="mi">6</span><span class="p">));</span>
                <span class="k">end</span><span class="p">;</span>
            <span class="k">end</span><span class="p">;</span>
        <span class="k">end</span><span class="p">;</span>
        <span class="n">matM</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span> <span class="nb">j</span><span class="p">)</span> <span class="p">=</span> <span class="o">-</span><span class="n">nonDiagR</span><span class="p">;</span>
        <span class="n">matM</span><span class="p">(</span><span class="nb">j</span><span class="p">,</span> <span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="o">-</span><span class="n">nonDiagR</span><span class="p">;</span>
    <span class="k">end</span><span class="p">;</span>
<span class="k">end</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Now</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">extend</span> <span class="n">this</span> <span class="n">matM</span> <span class="n">with</span> <span class="n">entries</span> <span class="n">which</span> <span class="n">came</span> <span class="n">from</span> <span class="n">voltage</span> <span class="n">sources</span><span class="p">.</span>
<span class="o">//</span> <span class="n">Generate</span> <span class="n">a</span> <span class="n">column</span> <span class="n">to</span> <span class="n">be</span> <span class="n">appended</span> <span class="n">to</span> <span class="n">matM</span> <span class="k">for</span> <span class="n">each</span> <span class="n">voltage</span> <span class="n">entry</span><span class="p">.</span>
<span class="o">//</span> <span class="n">Same</span> <span class="n">time</span> <span class="n">we</span> <span class="n">push</span> <span class="n">these</span> <span class="n">values</span> <span class="n">into</span> <span class="n">matrix</span> <span class="n">B</span> <span class="n">which</span> <span class="n">contains</span> <span class="n">sources</span><span class="p">.</span> <span class="n">Its</span>
<span class="o">//</span> <span class="n">dimenstion</span> <span class="n">is</span> <span class="n">listNodes</span><span class="o">+</span><span class="n">nV</span> <span class="n">by</span> <span class="mf">1.</span>
<span class="n">matB</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">numNodes</span><span class="o">+</span><span class="n">nV</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="o">//</span> <span class="n">mat</span> <span class="n">to</span> <span class="n">hold</span> <span class="n">sources</span><span class="p">.</span>

<span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">numNodes</span><span class="p">,</span> <span class="o">//</span> <span class="k">for</span> <span class="n">each</span> <span class="n">node</span> <span class="n">check</span> <span class="k">if</span> <span class="n">there</span> <span class="n">is</span> <span class="n">a</span> <span class="n">voltage</span> <span class="n">source</span><span class="p">.</span>
    <span class="n">colVoltS</span> <span class="p">=</span> <span class="nb">zeros</span><span class="p">(</span><span class="n">numNodes</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">for</span> <span class="nb">j</span> <span class="p">=</span> <span class="nb">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">:</span> <span class="n">numNodes</span><span class="p">,</span>
        <span class="k">for</span> <span class="n">p</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">lstsize</span><span class="p">(</span><span class="n">vS</span><span class="p">)</span><span class="o">/</span><span class="mi">7</span><span class="p">,</span>
            <span class="k">if</span> <span class="n">listNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">vS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="n">then</span> <span class="o">//</span> <span class="nb">i</span> <span class="n">is</span> <span class="n">the</span> <span class="n">first</span> <span class="n">node</span><span class="p">.</span>
                <span class="o">//</span><span class="nb">disp</span><span class="p">(</span><span class="s">&#39;A voltage source node.&#39;</span><span class="p">);</span>
                <span class="k">if</span> <span class="n">listNodes</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span> <span class="o">==</span> <span class="n">vS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="n">then</span> <span class="o">//</span> <span class="nb">j</span> <span class="n">is</span> <span class="n">the</span> <span class="n">second</span> <span class="n">node</span><span class="p">.</span>
                    <span class="n">colVoltS</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">colVoltS</span><span class="p">(</span><span class="nb">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                    <span class="n">matB</span><span class="p">(</span><span class="n">numNodes</span><span class="o">+</span><span class="nb">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="n">evstr</span><span class="p">(</span><span class="n">vS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span> <span class="o">//</span> <span class="n">value</span> <span class="n">V</span><span class="p">.</span>
                    <span class="o">//</span><span class="nb">disp</span><span class="p">(</span><span class="n">colVoltS</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">);</span>
                <span class="k">else</span> <span class="o">//</span> <span class="n">the</span> <span class="n">second</span> <span class="n">node</span> <span class="n">is</span> <span class="n">n0</span>
                    <span class="n">colVoltS</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="o">//</span><span class="nb">disp</span><span class="p">(</span><span class="n">colVoltS</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">);</span>
                    <span class="n">matB</span><span class="p">(</span><span class="n">numNodes</span><span class="o">+</span><span class="nb">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="n">evstr</span><span class="p">(</span><span class="n">vS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span> <span class="o">//</span> <span class="n">value</span> <span class="n">V</span><span class="p">.</span>
                <span class="k">end</span><span class="p">;</span>
            <span class="k">end</span><span class="p">;</span>
        <span class="k">end</span><span class="p">;</span>
    <span class="k">end</span><span class="p">;</span>
    <span class="o">//</span><span class="nb">disp</span><span class="p">(</span><span class="n">colVoltS</span><span class="p">,</span> <span class="s">&#39;D&#39;</span><span class="p">);</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">this</span> <span class="n">vector</span> <span class="n">is</span> <span class="n">non</span> <span class="n">zero</span><span class="p">.</span> <span class="n">Push</span> <span class="n">it</span> <span class="n">into</span> <span class="n">matM</span><span class="p">.</span>
    <span class="k">if</span> <span class="n">rank</span><span class="p">(</span><span class="n">colVoltS</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span> <span class="n">then</span>
        <span class="n">n</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="n">matM</span><span class="p">(</span><span class="mi">1</span><span class="p">,:));</span>
        <span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="nb">length</span><span class="p">(</span><span class="n">colVoltS</span><span class="p">),</span>
            <span class="o">//</span><span class="nb">disp</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">colVoltS</span><span class="p">,</span> <span class="s">&#39;A&#39;</span><span class="p">));</span>
            <span class="n">matM</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="n">colVoltS</span><span class="p">(</span><span class="nb">i</span><span class="p">);</span>
            <span class="n">matM</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">i</span><span class="p">)</span> <span class="p">=</span> <span class="n">colVoltS</span><span class="p">(</span><span class="nb">i</span><span class="p">);</span>
        <span class="k">end</span><span class="p">;</span>
    <span class="k">end</span><span class="p">;</span> <span class="o">//</span> <span class="n">our</span> <span class="n">matrix</span> <span class="n">is</span> <span class="n">ready</span><span class="p">.</span>
<span class="k">end</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Final</span> <span class="n">step</span><span class="p">.</span> <span class="n">We</span> <span class="n">have</span> <span class="n">to</span> <span class="n">push</span> <span class="n">current</span> <span class="n">source</span> <span class="n">into</span> <span class="n">source</span> <span class="n">matrix</span> <span class="p">(</span><span class="n">vector</span><span class="p">).</span>
<span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">numNodes</span><span class="p">,</span> <span class="o">//</span> <span class="k">for</span> <span class="n">each</span> <span class="n">node</span> <span class="n">check</span> <span class="k">if</span> <span class="n">there</span> <span class="n">is</span> <span class="n">a</span> <span class="n">current</span><span class="p">.</span>
    <span class="n">curS</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">to</span> <span class="n">hold</span> <span class="n">current</span> <span class="n">source</span> <span class="n">values</span><span class="p">.</span>
    <span class="k">for</span> <span class="nb">j</span> <span class="p">=</span> <span class="nb">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">:</span> <span class="n">numNodes</span><span class="p">,</span>
        <span class="k">for</span> <span class="n">p</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">lstsize</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span><span class="o">/</span><span class="mi">7</span><span class="p">,</span>
            <span class="k">if</span> <span class="n">listNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">iS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="n">then</span> <span class="o">//</span> <span class="nb">i</span> <span class="n">is</span> <span class="n">the</span> <span class="n">first</span> <span class="n">node</span><span class="p">.</span>
                <span class="o">//</span><span class="nb">disp</span><span class="p">(</span><span class="s">&#39;A current source node.&#39;</span><span class="p">);</span>
                <span class="k">if</span> <span class="n">listNodes</span><span class="p">(</span><span class="nb">j</span><span class="p">)</span> <span class="o">==</span> <span class="n">iS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="n">then</span> <span class="o">//</span> <span class="nb">j</span> <span class="n">is</span> <span class="n">the</span> <span class="n">second</span> <span class="n">node</span><span class="p">.</span>
                    <span class="n">curS</span> <span class="p">=</span> <span class="n">curS</span> <span class="o">+</span> <span class="n">evstr</span><span class="p">(</span><span class="n">iS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span> <span class="o">//</span> <span class="n">value</span> <span class="nb">i</span><span class="p">.</span>
                    <span class="n">matB</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="n">curS</span><span class="p">;</span>
                    <span class="n">matB</span><span class="p">(</span><span class="nb">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="o">-</span><span class="n">curS</span>
                <span class="k">else</span> <span class="o">//</span> <span class="n">the</span> <span class="n">second</span> <span class="n">node</span> <span class="n">is</span> <span class="n">n0</span>
                    <span class="n">curS</span> <span class="p">=</span> <span class="n">curS</span> <span class="o">+</span> <span class="n">evstr</span><span class="p">(</span><span class="n">iS</span><span class="p">((</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span> <span class="o">//</span> <span class="n">value</span> <span class="nb">i</span><span class="p">.</span>
                    <span class="n">matB</span><span class="p">(</span><span class="nb">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="n">curS</span><span class="p">;</span>
                <span class="k">end</span><span class="p">;</span>
            <span class="k">end</span><span class="p">;</span>
        <span class="k">end</span><span class="p">;</span>
    <span class="k">end</span><span class="p">;</span>
<span class="k">end</span><span class="p">;</span>

<span class="o">//</span> <span class="n">matM</span> <span class="n">is</span> <span class="n">our</span> <span class="n">coefficient</span> <span class="n">matrix</span><span class="p">.</span> <span class="n">matB</span> <span class="n">contains</span> <span class="n">sources</span><span class="p">.</span> <span class="n">Solve</span> <span class="n">it</span><span class="p">.</span>
<span class="n">msprintf</span><span class="p">(</span>&quot;<span class="n">Your</span> <span class="n">circuit</span> <span class="n">contains</span> <span class="c">%d current sources, %d voltage sources, and ...</span>
<span class="c">%d resistance. PLEASE NOTE THAT at this point we do not check topology of ...</span>
<span class="n">the</span> <span class="n">circuit</span><span class="p">.</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">your</span> <span class="n">file</span> <span class="n">describing</span> <span class="n">your</span> <span class="n">circuit</span> <span class="n">is</span> <span class="n">error</span> <span class="n">free</span><span class="p">.</span>&quot;<span class="p">,</span> <span class="c">...</span>
<span class="n">nI</span><span class="p">,</span> <span class="n">nV</span><span class="p">,</span> <span class="n">nR</span><span class="p">);</span>
<span class="n">endfunction</span><span class="p">;</span>
<span class="p">[</span><span class="o">/</span><span class="n">sourcecode</span><span class="p">]</span>


## <span class="mf">2.4</span> <span class="n">Top</span> <span class="n">most</span> <span class="n">level</span> <span class="n">script</span> <span class="n">and</span> <span class="n">its</span> <span class="n">result</span>


<span class="p">[</span><span class="n">sourcecode</span> <span class="n">language</span><span class="p">=</span>&quot;<span class="n">matlab</span>&quot;<span class="p">]</span>
<span class="o">//</span> <span class="n">Scilab</span> <span class="n">file</span>
<span class="o">//</span> <span class="n">Top</span> <span class="n">level</span> <span class="n">script</span> <span class="n">file</span> <span class="n">to</span> <span class="n">solve</span> <span class="n">a</span> <span class="n">circuit</span> <span class="n">using</span> <span class="n">MNA</span> <span class="n">method</span> <span class="n">which</span> <span class="n">I</span> <span class="n">do</span> <span class="n">not</span> <span class="n">like</span>
<span class="o">//</span> <span class="n">very</span> <span class="n">much</span><span class="p">.</span>

<span class="o">//</span> <span class="n">See</span> <span class="n">respective</span> <span class="k">function</span> <span class="n">files</span> <span class="k">for</span> <span class="n">more</span> <span class="n">details</span><span class="p">.</span>
<span class="o">//</span> <span class="n">Algorithm</span> <span class="n">implemented</span> <span class="n">is</span> <span class="n">standard</span> <span class="n">MNA</span> <span class="n">method</span><span class="p">.</span>

<span class="o">//</span> <span class="n">Execute</span> <span class="n">file</span> <span class="n">to</span> <span class="n">load</span> <span class="k">function</span> <span class="n">definition</span><span class="p">.</span>
<span class="n">exec</span><span class="p">(</span><span class="s">&#39;./generateMatrix.sci&#39;</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">following</span> <span class="n">file</span> <span class="n">exists</span><span class="p">.</span>
<span class="p">[</span><span class="n">matCoeff</span><span class="p">,</span> <span class="n">matSource</span><span class="p">,</span> <span class="n">listNodes</span><span class="p">,</span> <span class="n">nV</span><span class="p">]</span> <span class="p">=</span> <span class="n">generateMatrix</span><span class="p">(</span><span class="s">&#39;./myCircuit&#39;</span><span class="p">);</span>
<span class="o">//</span><span class="nb">disp</span><span class="p">(</span><span class="n">matCoeff</span><span class="p">);</span>
<span class="o">//</span><span class="nb">disp</span><span class="p">(</span><span class="n">matSource</span><span class="p">);</span>
<span class="o">//</span><span class="nb">disp</span><span class="p">(</span><span class="n">listNodes</span><span class="p">);</span>
 <span class="o">//</span> <span class="n">solve</span> <span class="n">these</span> <span class="n">equations</span><span class="p">.</span> <span class="n">matCoeff</span><span class="o">*</span><span class="n">x</span><span class="p">=</span> <span class="n">matSource</span><span class="p">.</span>
<span class="p">[</span><span class="n">ansNodes</span><span class="p">]</span> <span class="p">=</span> <span class="n">linsolve</span><span class="p">(</span><span class="n">matCoeff</span><span class="p">,</span> <span class="o">-</span><span class="n">matSource</span><span class="p">);</span>

<span class="nb">disp</span><span class="p">(</span><span class="s">&#39;Node potentials.&#39;</span><span class="p">)</span>
<span class="o">//</span> <span class="n">Display</span> <span class="n">the</span> <span class="n">results</span><span class="p">.</span>
<span class="n">n</span> <span class="p">=</span> <span class="nb">length</span><span class="p">(</span><span class="nb">length</span><span class="p">(</span><span class="n">listNodes</span><span class="p">));</span>
<span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span>
    <span class="n">mprintf</span><span class="p">(</span>&quot;<span class="n">Node</span> <span class="c">%s votage is : %f\n&quot;, listNodes(i), ansNodes(i));</span>
<span class="k">end</span><span class="p">;</span>
<span class="nb">disp</span><span class="p">(</span><span class="s">&#39;Current through voltage sources.&#39;</span><span class="p">);</span>
<span class="k">for</span> <span class="nb">i</span> <span class="p">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="p">:</span> <span class="nb">length</span><span class="p">(</span><span class="n">ansNodes</span><span class="p">),</span>
    <span class="n">mprintf</span><span class="p">(</span>&quot;<span class="o">\</span><span class="n">nCurrent</span> <span class="n">through</span> <span class="n">voltage</span> <span class="n">source</span> <span class="p">(</span><span class="c">%s, %s) is : %f&quot;, nV(i-n),...</span>
    <span class="n">nV</span><span class="p">(</span><span class="nb">i</span><span class="o">-</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">ansNodes</span><span class="p">(</span><span class="nb">i</span><span class="p">));</span>
<span class="k">end</span><span class="p">;</span>

<span class="o">//</span> <span class="n">This</span> <span class="n">ends</span> <span class="n">our</span> <span class="n">endeavor</span><span class="p">.</span>
<span class="n">exit</span><span class="p">();</span>
<span class="p">[</span><span class="o">/</span><span class="n">sourcecode</span><span class="p">]</span>

<span class="n">Results</span> <span class="k">for</span> <span class="n">the</span> <span class="n">file</span> <span class="mf">2.1</span><span class="p">.</span>

<span class="p">[</span><span class="n">sourcecode</span><span class="p">]</span>
<span class="n">Node</span> <span class="n">potentials</span><span class="p">.</span>
<span class="n">Node</span> <span class="n">n1</span> <span class="n">votage</span> <span class="n">is</span> <span class="p">:</span> <span class="mf">5.000000</span>
<span class="n">Node</span> <span class="n">n3</span> <span class="n">votage</span> <span class="n">is</span> <span class="p">:</span> <span class="mf">3.000000</span>
<span class="n">Node</span> <span class="n">n2</span> <span class="n">votage</span> <span class="n">is</span> <span class="p">:</span> <span class="mf">3.200000</span>

<span class="n">Current</span> <span class="n">through</span> <span class="n">voltage</span> <span class="n">sources</span><span class="p">.</span>
<span class="n">Current</span> <span class="n">through</span> <span class="n">voltage</span> <span class="n">source</span> <span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n0</span><span class="p">)</span> <span class="n">is</span> <span class="p">:</span> <span class="o">-</span><span class="mf">18.000000</span>
<span class="n">Current</span> <span class="n">through</span> <span class="n">voltage</span> <span class="n">source</span> <span class="p">(</span><span class="n">n0</span><span class="p">,</span> <span class="n">n3</span><span class="p">)</span> <span class="n">is</span> <span class="p">:</span> <span class="mf">4.320000</span>
</code></pre></div>


<p>RESOURCES : <a href="http://dilawarnotes.files.wordpress.com/2010/09/mna_scilab1.pdf">mna_scilab_ver0.9</a></p>

<p>[soucecode language="matlab"]</p>

</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li> <a href="/numerical%20computation/2014/01/30/Coding-With-Floats/">Coding with float</a></li>
    
      <li> <a href="/noguinomousenoproblem/2014/01/29/Using-mutt/">Using mutt, saving password and writing mail in markdown</a></li>
    
      <li> <a href="/[%22tutorial%22,%20%22literate%20programming%22]/2013/10/30/Python-frontend-for-noweb/">Python front-end for Noweb literate tool</a></li>
    
  </ul>
</div>

<script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>

<!-- Google analytic -->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47774588-1', 'dilawar.github.io');
    ga('send', 'pageview');
</script>

<div id="comment">
  
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'dilawarblog'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>



    </section>

    <!-- Latex in post -->
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- Google analytic -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-47774588-1', 'dilawar.github.io');
        ga('send', 'pageview');
    </script>
</body>
</html>
